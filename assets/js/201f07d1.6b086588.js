"use strict";(self.webpackChunkepinio_docusaurus=self.webpackChunkepinio_docusaurus||[]).push([[10497],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=s(n),h=i,d=u["".concat(p,".").concat(h)]||u[h]||m[h]||o;return n?a.createElement(d,r(r({ref:t},c),{},{components:n})):a.createElement(d,r({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var s=2;s<o;s++)r[s]=n[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},24176:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return p},default:function(){return h},frontMatter:function(){return l},metadata:function(){return s},toc:function(){return m}});var a=n(83117),i=n(80102),o=(n(67294),n(3905)),r=["components"],l={sidebar_label:"Custom application Helm charts",sidebar_position:15,title:"Creating custom application Helm charts",description:"How to create custom application Helm charts",keywords:["epinio","kubernetes","custom application helm charts"],"doc-type":["how-to"],"doc-topic":["epinio","how-to","customize","custom-app-helm-chart"],"doc-persona":["epinio-operator"]},p=void 0,s={unversionedId:"howtos/customization/create_custom_appcharts",id:"version-1.11.0/howtos/customization/create_custom_appcharts",title:"Creating custom application Helm charts",description:"How to create custom application Helm charts",source:"@site/versioned_docs/version-1.11.0/howtos/customization/create_custom_appcharts.md",sourceDirName:"howtos/customization",slug:"/howtos/customization/create_custom_appcharts",permalink:"/howtos/customization/create_custom_appcharts",draft:!1,editUrl:"https://github.com/epinio/docs/edit/main/versioned_docs/version-1.11.0/howtos/customization/create_custom_appcharts.md",tags:[],version:"1.11.0",sidebarPosition:15,frontMatter:{sidebar_label:"Custom application Helm charts",sidebar_position:15,title:"Creating custom application Helm charts",description:"How to create custom application Helm charts",keywords:["epinio","kubernetes","custom application helm charts"],"doc-type":["how-to"],"doc-topic":["epinio","how-to","customize","custom-app-helm-chart"],"doc-persona":["epinio-operator"]},sidebar:"docs",previous:{title:"Custom builders",permalink:"/howtos/customization/custom_builder"},next:{title:"Custom values for service Helm charts",permalink:"/howtos/customization/using_custom_service_values"}},c={},m=[{value:"Setting up a custom Helm chart",id:"setting-up-a-custom-helm-chart",level:2},{value:"Creating the Helm chart",id:"creating-the-helm-chart",level:3},{value:"Making the helm Chart known to Epinio",id:"making-the-helm-chart-known-to-epinio",level:3},{value:"User-settable configuration values",id:"user-settable-configuration-values",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Going further",id:"going-further",level:2}],u={toc:m};function h(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Epinio deploys applications on Kubernetes as ",(0,o.kt)("a",{parentName:"p",href:"https://helm.sh/"},"Helm charts"),"."),(0,o.kt)("p",null,"By default, Epinio provides a standard Helm chart installation.\nHowever, operators may wish to create custom charts specific to their environment,\nand register them in Epinio, so ",(0,o.kt)("a",{parentName:"p",href:"/howtos/other/using_custom_appcharts"},"their developers can use them"),"."),(0,o.kt)("h2",{id:"setting-up-a-custom-helm-chart"},"Setting up a custom Helm chart"),(0,o.kt)("p",null,"To add a custom Helm chart to the system, there are two mandatory steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create the chart,"),(0,o.kt)("li",{parentName:"ol"},"Make it known to the Epinio installation")),(0,o.kt)("p",null,"The following two sections explain these steps in detail."),(0,o.kt)("p",null,"An advanced feature of custom application charts is the ability to expose user-settable configuration values to the user."),(0,o.kt)("h3",{id:"creating-the-helm-chart"},"Creating the Helm chart"),(0,o.kt)("p",null,"You can use the standard chart provided by Epinio as a template for the modifications."),(0,o.kt)("p",null,"You can download the chart from\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/epinio/helm-charts/tree/main/chart/application"},"the Epinio repository"),"\ninto a directory ",(0,o.kt)("inlineCode",{parentName:"p"},"<work-dir>")," of your choice,\nor, you can clone the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/epinio/helm-charts.git"},"Epinio Helm chart repository"),",\nagain, into a ",(0,o.kt)("inlineCode",{parentName:"p"},"<work-dir>")," of your choice."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"git clone https://github.com/epinio/helm-charts.git\n")),(0,o.kt)("p",null,"The chart is in the subdirectory ",(0,o.kt)("inlineCode",{parentName:"p"},"helm-charts/chart/application"),"."),(0,o.kt)("p",null,"In the following steps,\nthe commands given,\nassume that the directory ",(0,o.kt)("inlineCode",{parentName:"p"},"<work-dir>")," is the working directory."),(0,o.kt)("p",null,"You create a variant of the chart by adding an annotation to every application ",(0,o.kt)("inlineCode",{parentName:"p"},"Deployment"),".\nThe annotation enables the filtering of Epinio applications in ",(0,o.kt)("a",{parentName:"p",href:"https://www.fluentd.org/"},"fluentd"),"."),(0,o.kt)("p",null,"Open the file ",(0,o.kt)("inlineCode",{parentName:"p"},"helm-charts/chart/application/templates/deployment.yaml")," in your editor.\nThis file is the template for the application's ",(0,o.kt)("inlineCode",{parentName:"p"},"Deployment")," resource."),(0,o.kt)("p",null,"First, locate the section ",(0,o.kt)("inlineCode",{parentName:"p"},"annotations"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"[...]\n  template:\n    metadata:\n      annotations:\n        app.kubernetes.io/name: {{ .Values.epinio.appName }}\n[...]\n")),(0,o.kt)("p",null,"Add the following annotations:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'fluentd-enable: "true"\nfluentd-application-name: {{ .Values.epinio.appName }}\n')),(0,o.kt)("p",null,"The result should look like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'[...]\n  template:\n    metadata:\n      annotations:\n        fluentd-enable: "true"\n        fluentd-application-name: {{ .Values.epinio.appName }}\n        app.kubernetes.io/name: {{ .Values.epinio.appName }}\n[...]\n')),(0,o.kt)("p",null,"The templating uses the ",(0,o.kt)("inlineCode",{parentName:"p"},".Values.epinio.appName")," field to insert the application name into the annotation."),(0,o.kt)("p",null,"An explanation of the values Epinio sets when deploying an application using the chart is in the\n",(0,o.kt)("a",{parentName:"p",href:"/references/customization/appcharts#configuration"},"Application Chart Reference"),".\nIt's also available locally in the comments at the top of file ",(0,o.kt)("inlineCode",{parentName:"p"},"helm-charts/chart/application/values.yaml"),"."),(0,o.kt)("p",null,"Once you have modified the chart, use the following command to package the changed chart into a tarball:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"helm package helm-charts/chart/application\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"helm")," command places the tarball into ",(0,o.kt)("inlineCode",{parentName:"p"},"<work-dir>")," and the file name should be ",(0,o.kt)("inlineCode",{parentName:"p"},"application-VERSION.tgz")," where ",(0,o.kt)("inlineCode",{parentName:"p"},"VERSION")," is the chart version."),(0,o.kt)("p",null,"Don't change the chart version.\nVersioned chart development is out of scope for this How-to."),(0,o.kt)("h3",{id:"making-the-helm-chart-known-to-epinio"},"Making the helm Chart known to Epinio"),(0,o.kt)("p",null,"Once you have created the new chart,\nit's necessary to place the generated tarball on a web server.\nA few possible options are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"A server in the public cloud available to you"),(0,o.kt)("li",{parentName:"ul"},"The company's host web server, if available, and permitted by company policies"),(0,o.kt)("li",{parentName:"ul"},"A personal web server"),(0,o.kt)("li",{parentName:"ul"},"A local web server, perhaps an nginx in a docker container")),(0,o.kt)("p",null,"Given the range of possible options, this How-to assumes that the tarball is available at the example URL."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"https://mydomain.org/epinio-application-fluentd.tgz\n")),(0,o.kt)("p",null,"Copy the following YAML text,\nchange the ",(0,o.kt)("inlineCode",{parentName:"p"},"RELEASE_NAMESPACE")," value to the namespace where Epinio was installed,\nby default it's ",(0,o.kt)("inlineCode",{parentName:"p"},"epinio"),", and add it to a file of your choice:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: application.epinio.io/v1\nkind: AppChart\nmetadata:\n  namespace: RELEASE_NAMESPACE\n  name: fluentd\nspec:\n  shortDescription: Fluentd filterable standard deployment\n  description: Epinio standard support chart extended for fluentd filtering\n  helmChart: https://mydomain.org/epinio-application-fluentd.tgz\n")),(0,o.kt)("p",null,"This How-to assumes that the name of the chosen file is ",(0,o.kt)("inlineCode",{parentName:"p"},"fluentd-appchart.yaml"),"."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"This is a Kubernetes custom resource, which describes the new Helm chart to Epinio.\nIn this example, it provides the information about the name, the source and descriptions.")),(0,o.kt)("p",null,"The Epinio installation provides the necessary Kubernetes CRD."),(0,o.kt)("p",null,"Apply this resource to the Epinio cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"kubectl apply -f fluentd-appchart.yaml\n")),(0,o.kt)("p",null,"Verify that the new chart is now registered in Epinio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"epinio app chart list\n")),(0,o.kt)("p",null,"You can also see the details of the chart in Epinio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-console"},"epinio app chart show fluentd\n")),(0,o.kt)("h3",{id:"user-settable-configuration-values"},"User-settable configuration values"),(0,o.kt)("p",null,"To expose the user-settable configuration value ",(0,o.kt)("inlineCode",{parentName:"p"},"foo")," the created application chart has to look for this variable in the ",(0,o.kt)("inlineCode",{parentName:"p"},".Values.userConfig")," map.\nThat is, it has to use the helm variable ",(0,o.kt)("inlineCode",{parentName:"p"},".Values.userConfig.foo"),"."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The chart should use a default value when this helm variable isn't set.")),(0,o.kt)("p",null,"With the application chart exposing ",(0,o.kt)("inlineCode",{parentName:"p"},"foo")," Epinio has to be aware of the configuration value by adding a specification to the ",(0,o.kt)("inlineCode",{parentName:"p"},"AppChart")," resource describing it."),(0,o.kt)("p",null,"Do this by adding an entry ",(0,o.kt)("inlineCode",{parentName:"p"},"foo")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.settings")," map of the AppChart resource.\nThis entry is itself a map, with a mandatory ",(0,o.kt)("inlineCode",{parentName:"p"},"type")," field, and type-dependent ",(0,o.kt)("strong",{parentName:"p"},"optional")," restrictions on the valid values of ",(0,o.kt)("inlineCode",{parentName:"p"},"foo"),"."),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'kind: AppChart\nmetadata:\n  [...]\nspec:\n  [...]\n  settings:\n    foo:\n      type: integer\n      minimum: \'42\'\n    bar:\n      type: number\n      maximum: \'122\'\n    flag:\n       type: bool\n    mode:\n      type: string\n      enum:\n        - "sequential"\n        - "out of order"\n        - "randomized"\n')),(0,o.kt)("p",null,"The valid types and their possible restrictions are:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Type"),(0,o.kt)("th",{parentName:"tr",align:null},"Restriction"),(0,o.kt)("th",{parentName:"tr",align:null},"Semantics"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"integer")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"minimum")),(0,o.kt)("td",{parentName:"tr",align:null},"Minimum valid integer value")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null}),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"maximum")),(0,o.kt)("td",{parentName:"tr",align:null},"Maximum valid integer value")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"number")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"minimum")),(0,o.kt)("td",{parentName:"tr",align:null},"floating-point")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null}),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"maximum")),(0,o.kt)("td",{parentName:"tr",align:null},"floating-point")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"string")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"enum")),(0,o.kt)("td",{parentName:"tr",align:null},"Sequence of valid values")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"bool")),(0,o.kt)("td",{parentName:"tr",align:null},"n/a"),(0,o.kt)("td",{parentName:"tr",align:null})))),(0,o.kt)("p",null,"Restrictions set on a type not supporting them, for example, a ",(0,o.kt)("inlineCode",{parentName:"p"},"minimum")," on a ",(0,o.kt)("inlineCode",{parentName:"p"},"string"),"-type configuration value, are ignored."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The restriction values have to be YAML ",(0,o.kt)("strong",{parentName:"p"},"strings"),", regardless the type of the configuration value.\nNote how in the example the ",(0,o.kt)("inlineCode",{parentName:"p"},"maximum")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"minimum")," values are quoted to make them strings.")),(0,o.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("p",null,"If the new Helm chart isn't correctly registered in Epinio,\ncheck that the ",(0,o.kt)("inlineCode",{parentName:"p"},"RELEASE_NAMESPACE")," is set in ",(0,o.kt)("inlineCode",{parentName:"p"},"fluentd-appchart.yaml"),"."),(0,o.kt)("h2",{id:"going-further"},"Going further"),(0,o.kt)("p",null,"The standard app chart, and the chart created here,\nuse a Kubernetes ",(0,o.kt)("inlineCode",{parentName:"p"},"Deployment")," as the main resource describing the active application."),(0,o.kt)("p",null,"Up to Epinio version 1.0, this was the only kind of resource supported.\nEpinio supports other kinds of controllers,\nfor example, ",(0,o.kt)("inlineCode",{parentName:"p"},"StatefulSet")," since versions greater than 1.0."),(0,o.kt)("p",null,"However, even when changing controllers,\nit's important to keep the ",(0,o.kt)("inlineCode",{parentName:"p"},"Pod")," annotations and labels the same as for the standard chart.\nThis lets Epinio's server locate the required resources and use them."),(0,o.kt)("p",null,"Here's a couple of examples:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The value of ",(0,o.kt)("inlineCode",{parentName:"p"},"epinio.io/stage-id")," is the id of the staging Pod which created the application's image.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The value of ",(0,o.kt)("inlineCode",{parentName:"p"},"epinio.io/app-container")," is the name of the application's main ",(0,o.kt)("inlineCode",{parentName:"p"},"Container"),", used by ",(0,o.kt)("inlineCode",{parentName:"p"},"epinio exec"),".\nThis label has to match the actual name of the container in the pod spec."))))}h.isMDXComponent=!0}}]);