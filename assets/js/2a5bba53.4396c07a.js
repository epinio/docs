"use strict";(self.webpackChunkepinio_docusaurus=self.webpackChunkepinio_docusaurus||[]).push([[72799],{3905:function(e,n,t){t.d(n,{Zo:function(){return s},kt:function(){return m}});var i=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,o=function(e,n){if(null==e)return{};var t,i,o={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var p=i.createContext({}),c=function(e){var n=i.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},s=function(e){var n=c(e.components);return i.createElement(p.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),d=c(t),m=o,h=d["".concat(p,".").concat(m)]||d[m]||u[m]||a;return t?i.createElement(h,r(r({ref:n},s),{},{components:t})):i.createElement(h,r({ref:n},s))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,r=new Array(a);r[0]=d;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var c=2;c<a;c++)r[c]=t[c];return i.createElement.apply(null,r)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},74325:function(e,n,t){t.r(n),t.d(n,{assets:function(){return s},contentTitle:function(){return p},default:function(){return m},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return u}});var i=t(83117),o=t(80102),a=(t(67294),t(3905)),r=["components"],l={sidebar_label:"OIDC authentication",title:""},p="OIDC authentication",c={unversionedId:"references/authentication_oidc",id:"version-1.13.7/references/authentication_oidc",title:"",description:"Since version 1.3.0, Epinio has integrated Dex as an identity provider, which adds support for external OIDC providers.",source:"@site/versioned_docs/version-1.13.7/references/authentication_oidc.md",sourceDirName:"references",slug:"/references/authentication_oidc",permalink:"/references/authentication_oidc",draft:!1,editUrl:"https://github.com/epinio/docs/edit/main/versioned_docs/version-1.13.7/references/authentication_oidc.md",tags:[],version:"1.13.7",frontMatter:{sidebar_label:"OIDC authentication",title:""},sidebar:"docs",previous:{title:"API",permalink:"/references/api"},next:{title:"Authorization",permalink:"/references/authorization"}},s={},u=[{value:"Groups and Roles mapping",id:"groups-and-roles-mapping",level:2},{value:"Connector notes",id:"connector-notes",level:2},{value:"Google (Gmail / Workspace) Example",id:"google-gmail--workspace-example",level:3}],d={toc:u};function m(e){var n=e.components,t=(0,o.Z)(e,r);return(0,a.kt)("wrapper",(0,i.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"oidc-authentication"},"OIDC authentication"),(0,a.kt)("p",null,"Since version ",(0,a.kt)("strong",{parentName:"p"},"1.3.0"),", Epinio has integrated ",(0,a.kt)("a",{parentName:"p",href:"https://dexidp.io/"},"Dex")," as an identity provider, which adds support for external OIDC providers."),(0,a.kt)("p",null,"To authenticate through Dex, you can use the login command with the ",(0,a.kt)("inlineCode",{parentName:"p"},"--oidc")," flag. This will open a web page where you can authenticate with the configured providers."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"epinio login --oidc https://epinio.mydomain.com\n")),(0,a.kt)("p",null,"If you are using the ",(0,a.kt)("inlineCode",{parentName:"p"},"epinio")," cli on a machine without a browser, you can provide the ",(0,a.kt)("inlineCode",{parentName:"p"},"--prompt")," flag. This will give you the URL of a web page where you can authenticate even on a different machine. After logging in and pressing the ",(0,a.kt)("inlineCode",{parentName:"p"},"Grant Access")," button, the page will return the authorization code that you have to copy and paste back to the ",(0,a.kt)("inlineCode",{parentName:"p"},"epinio")," CLI input to finish the authentication process."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"epinio login --oidc --prompt https://epinio.172.21.0.4.sslip.io\n")),(0,a.kt)("p",null,"By default, only the local connector is set up with two users (",(0,a.kt)("inlineCode",{parentName:"p"},"admin@epinio.io")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"epinio@epinio.io"),").\nTo add more connectors, you can edit the Dex configuration file (key ",(0,a.kt)("inlineCode",{parentName:"p"},"config.yaml"),"), stored in the ",(0,a.kt)("inlineCode",{parentName:"p"},"dex-config")," secret in the ",(0,a.kt)("inlineCode",{parentName:"p"},"epinio")," namespace."),(0,a.kt)("p",null,"After a successful login, a new Epinio user will be created with the username matching the email used to login and returned by the provider."),(0,a.kt)("p",null,"If you want to login with the same email through the Epinio UI, you should set a password for your user by patching the user secret."),(0,a.kt)("p",null,"Find the secret name:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'export EPINIO_USERNAME=$(echo -n \'admin@epinio.io\' | base64)\nkubectl get secret -n epinio -o json -l epinio.io/api-user-credentials | jq -r ".items[] | select(.data.username==\\"$EPINIO_USERNAME\\") | .metadata.name"\n\nruser-adminepinioio-9341763ee7dcbce070e7c14f246ec8291e9a7278\n')),(0,a.kt)("p",null,"Patch the secret with the encrypted password:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'export EPINIO_PASSWORD=$(echo -n \'$2a$10$6bCi5NMstMK781In7JGiL.B44pgoplUb330FQvm6mVXMppbXBPiXS\' | base64 -w0)\nkubectl patch secret -n epinio -p="{\\"data\\":{\\"password\\": \\"$EPINIO_PASSWORD\\"}}" ruser-adminepinioio-9341763ee7dcbce070e7c14f246ec8291e9a7278\n\nsecret/ruser-adminepinioio-9341763ee7dcbce070e7c14f246ec8291e9a7278 patched\n')),(0,a.kt)("p",null,"You're now able to login with the credentials in Epinio UI."),(0,a.kt)("h2",{id:"groups-and-roles-mapping"},"Groups and Roles mapping"),(0,a.kt)("p",null,"Dex is configured via the ",(0,a.kt)("inlineCode",{parentName:"p"},"dex-config")," secret in the ",(0,a.kt)("inlineCode",{parentName:"p"},"epinio")," namespace.",(0,a.kt)("br",{parentName:"p"}),"\n","The secret is of type ",(0,a.kt)("inlineCode",{parentName:"p"},"Opaque")," and carries multiple string values that Epinio reads at start-up:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"config.yaml"),": the Dex configuration file (connectors, static clients, etc.)."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"rolesMapping"),": optional mapping that links external groups to Epinio roles.")),(0,a.kt)("p",null,"When creating or updating the secret, you must provide each entry as a separate key; do ",(0,a.kt)("strong",{parentName:"p"},"not"),"\nappend the roles block to ",(0,a.kt)("inlineCode",{parentName:"p"},"config.yaml"),". The snippet below shows the structure using\n",(0,a.kt)("inlineCode",{parentName:"p"},"stringData")," for readability (Kubernetes will store the values base64-encoded under ",(0,a.kt)("inlineCode",{parentName:"p"},"data"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Secret\nmetadata:\n  name: dex-config\n  namespace: epinio\ntype: Opaque\nstringData:\n  config.yaml: |-\n    connectors:\n    - type: github\n      id: github\n      name: GitHub\n      config:\n        loadAllGroups: true\n        orgs:\n        - name: Org1\n  rolesMapping: |-\n    - connectorId: github\n      groups:\n      - id: Org1:Admins\n        roles:\n        - admin\n      - id: Org1:TeamBlue\n        roles:\n        - user\n        - admin:workspace\n")),(0,a.kt)("p",null,"You can create the secret from files with\n",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl create secret generic dex-config -n epinio --from-file=config.yaml --from-file=rolesMapping"),",\nor patch the existing secret using a YAML file structured as above."),(0,a.kt)("p",null,"In the previous example, if the user is a member of both ",(0,a.kt)("inlineCode",{parentName:"p"},"Org1:Admins")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"Org1:TeamBlue"),"\nthen that user will get the ",(0,a.kt)("inlineCode",{parentName:"p"},"admin"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"user")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"admin:workspace")," roles. If no roles are found\nand a default role is set then the user will receive that default Epinio role."),(0,a.kt)("h2",{id:"connector-notes"},"Connector notes"),(0,a.kt)("p",null,"Dex ships with a broad catalogue of connectors (GitHub, GitLab, Google, LDAP, generic OIDC, Azure/Entra ID, and more).",(0,a.kt)("br",{parentName:"p"}),"\n","Each connector exposes its own configuration keys and prerequisites. Refer to the official Dex connector\nreference for the complete list and latest options.",(0,a.kt)("sup",{parentName:"p",id:"fnref-dex-connectors"},(0,a.kt)("a",{parentName:"sup",href:"#fn-dex-connectors",className:"footnote-ref"},"dex-connectors"))),(0,a.kt)("h3",{id:"google-gmail--workspace-example"},"Google (Gmail / Workspace) Example"),(0,a.kt)("p",null,"Below is just an example of how to set up a connector. Please reference the ",(0,a.kt)("a",{parentName:"p",href:"https://dexidp.io/docs/connectors"},"Dex connector documentation")," for more information. "),(0,a.kt)("p",null,"When integrating Google accounts via the Dex ",(0,a.kt)("inlineCode",{parentName:"p"},"google")," connector:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Create an OAuth 2.0 ",(0,a.kt)("strong",{parentName:"li"},"Web application")," client in Google Cloud Console and note the ",(0,a.kt)("inlineCode",{parentName:"li"},"Client ID")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"Client secret"),"."),(0,a.kt)("li",{parentName:"ul"},"Add your Dex callback (for example ",(0,a.kt)("inlineCode",{parentName:"li"},"https://dex.example.org/callback"),") to the OAuth client\u2019s authorized redirect URIs and reuse it as the connector ",(0,a.kt)("inlineCode",{parentName:"li"},"redirectURI"),"."),(0,a.kt)("li",{parentName:"ul"},"Restrict access to specific Google Workspace domains by listing them under ",(0,a.kt)("inlineCode",{parentName:"li"},"hostedDomains"),". Omit the field to allow personal Gmail accounts."),(0,a.kt)("li",{parentName:"ul"},"If you need group information for role mapping, supply a service account with Admin SDK rights (",(0,a.kt)("inlineCode",{parentName:"li"},"serviceAccount")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"adminEmail"),") and list the Workspace group email addresses in ",(0,a.kt)("inlineCode",{parentName:"li"},"groups"),"."),(0,a.kt)("li",{parentName:"ul"},"Optionally extend ",(0,a.kt)("inlineCode",{parentName:"li"},"scopes")," or set ",(0,a.kt)("inlineCode",{parentName:"li"},"promptType: select_account")," to let users pick among multiple Google logins.")),(0,a.kt)("p",null,"Example connector snippet:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'config.yaml: |-\n  connectors:\n  - type: google\n    id: google\n    name: Google\n    config:\n      clientID: <google-client-id>\n      clientSecret: <google-client-secret>\n      redirectURI: https://dex.example.org/callback\n      hostedDomains:\n      - example.com\n      serviceAccount: |-\n        {\n          "type": "service_account",\n          "...": "..."\n        }\n      adminEmail: admin@example.com\n      groups:\n      - name: engineering@example.com\n      promptType: select_account\n')),(0,a.kt)("p",null,"Combine this connector definition with the ",(0,a.kt)("inlineCode",{parentName:"p"},"rolesMapping")," key shown earlier to assign Epinio roles to Google groups."),(0,a.kt)("div",{className:"footnotes"},(0,a.kt)("hr",{parentName:"div"}),(0,a.kt)("ol",{parentName:"div"},(0,a.kt)("li",{parentName:"ol",id:"fn-dex-connectors"},(0,a.kt)("a",{parentName:"li",href:"https://dexidp.io/docs/connectors/"},"Dex connector reference"),(0,a.kt)("a",{parentName:"li",href:"#fnref-dex-connectors",className:"footnote-backref"},"\u21a9")))))}m.isMDXComponent=!0}}]);