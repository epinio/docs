"use strict";(self.webpackChunkepinio_docusaurus=self.webpackChunkepinio_docusaurus||[]).push([[34446],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var i=n(67294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,i,s=function(e,t){if(null==e)return{};var n,i,s={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var p=i.createContext({}),l=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return i.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},h=i.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,p=e.parentName,c=a(e,["components","mdxType","originalType","parentName"]),h=l(n),d=s,m=h["".concat(p,".").concat(d)]||h[d]||u[d]||r;return n?i.createElement(m,o(o({ref:t},c),{},{components:n})):i.createElement(m,o({ref:t},c))}));function d(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,o=new Array(r);o[0]=h;var a={};for(var p in t)hasOwnProperty.call(t,p)&&(a[p]=t[p]);a.originalType=e,a.mdxType="string"==typeof e?e:s,o[1]=a;for(var l=2;l<r;l++)o[l]=n[l];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}h.displayName="MDXCreateElement"},92094:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return p},default:function(){return d},frontMatter:function(){return a},metadata:function(){return l},toc:function(){return u}});var i=n(83117),s=n(80102),r=(n(67294),n(3905)),o=["components"],a={sidebar_label:"Epinio push process",title:"The Epinio push process in detail",description:"The Epinio push process in detail",keywords:["epinio","kubernetes","push process"]},p=void 0,l={unversionedId:"explanations/detailed-push-process",id:"explanations/detailed-push-process",title:"The Epinio push process in detail",description:"The Epinio push process in detail",source:"@site/docs/explanations/detailed-push-process.md",sourceDirName:"explanations",slug:"/explanations/detailed-push-process",permalink:"/next/explanations/detailed-push-process",draft:!1,editUrl:"https://github.com/epinio/docs/edit/main/docs/explanations/detailed-push-process.md",tags:[],version:"current",frontMatter:{sidebar_label:"Epinio push process",title:"The Epinio push process in detail",description:"The Epinio push process in detail",keywords:["epinio","kubernetes","push process"]},sidebar:"docs",previous:{title:"Advanced topics",permalink:"/next/explanations/advanced"},next:{title:"Principles",permalink:"/next/explanations/principles"}},c={},u=[{value:"Epinio push (step 1)",id:"epinio-push-step-1",level:2},{value:"Copying the code to S3 (step 2)",id:"copying-the-code-to-s3-step-2",level:2},{value:"Staging the app (step 3)",id:"staging-the-app-step-3",level:2},{value:"Trigger the job (step 4)",id:"trigger-the-job-step-4",level:2},{value:"Fetch the code (step 5)",id:"fetch-the-code-step-5",level:2},{value:"Unpack the sources (step 6)",id:"unpack-the-sources-step-6",level:2},{value:"Stage (step 7)",id:"stage-step-7",level:2},{value:"Run (step 8)",id:"run-step-8",level:2},{value:"Pull image (step 9)",id:"pull-image-step-9",level:2},{value:"Ingress implementation",id:"ingress-implementation",level:2},{value:"The process diagram",id:"the-process-diagram",level:2},{value:"Credits",id:"credits",level:2}],h={toc:u};function d(e){var t=e.components,a=(0,s.Z)(e,o);return(0,r.kt)("wrapper",(0,i.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Epinio makes use of well supported, well known projects.\nThere is further discussion about this in the\n(",(0,r.kt)("a",{parentName:"p",href:"/next/explanations/principles#guidelines-soft-principles"},"project principles"),") document.\nWhile doing so, Epinio makes sure those components are correctly deployed and work together seamlessly.\nThis detailed description of the Epinio push process lets you understand the components and their relationships."),(0,r.kt)("p",null,"There is a diagram of the Epinio push process later on this page.\nRefer to it while reading the text to aid understanding.\nThe number labels on the paths in the image indicate process ordering."),(0,r.kt)("h2",{id:"epinio-push-step-1"},"Epinio push (step 1)"),(0,r.kt)("p",null,"Epinio exposes an API server, running inside the Kubernetes cluster.\nIt's used by all clients, including the CLI, to communicate with Epinio."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"epinio push")," CLI command, creates an archive containing application code.\nThis archive package is uploaded to the API server (step 1a).\nA Kubernetes Ingress controller (for example, Traefik) routes your request to the API server (1b)."),(0,r.kt)("p",null,"Request authentication at the API server uses\nBasicAuth, a session cookie or, if using WebSockets, a token."),(0,r.kt)("h2",{id:"copying-the-code-to-s3-step-2"},"Copying the code to S3 (step 2)"),(0,r.kt)("p",null,"The Epinio helm-chart can install either ",(0,r.kt)("a",{parentName:"p",href:"https://min.io/"},"Minio")," (the default)\nor ",(0,r.kt)("a",{parentName:"p",href:"https://s3gw.io/"},"s3gw")," on your cluster.\nYou can also ",(0,r.kt)("a",{parentName:"p",href:"/next/howtos/customization/setup_external_s3"},"configure external S3"),".\nBoth Minio and s3gw are S3-compatible storage solutions which Epinio uses to store application source code.\nThe chosen S3 storage solution is later used by the staging job."),(0,r.kt)("p",null,"After successful authentication (step 1),\nthe API server uploads the package to the S3 endpoint and\nresponds with a ",(0,r.kt)("inlineCode",{parentName:"p"},"blobUID")," that can be later used to reference the uploaded package."),(0,r.kt)("h2",{id:"staging-the-app-step-3"},"Staging the app (step 3)"),(0,r.kt)("p",null,"When the upload request is complete, the CLI sends a request to the ",(0,r.kt)("inlineCode",{parentName:"p"},"stage")," endpoint of the Epinio API server.\nThis instructs the server to start the staging of the uploaded code."),(0,r.kt)("h2",{id:"trigger-the-job-step-4"},"Trigger the job (step 4)"),(0,r.kt)("p",null,"When the Epinio API server receives the stage request,\nit creates a\n",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/job/"},(0,r.kt)("inlineCode",{parentName:"a"},"Job")),"\nthat runs the staging scripts using the version of the code referenced in the request.\nThis job has 3 steps and each one is a script stored in a ",(0,r.kt)("inlineCode",{parentName:"p"},"ConfigMap")," called ",(0,r.kt)("inlineCode",{parentName:"p"},"epinio-stage-scripts"),".\nThe namespace containing the Epinio installation contains this ",(0,r.kt)("inlineCode",{parentName:"p"},"ConfigMap"),".\nThe following three sections describe their roles."),(0,r.kt)("h2",{id:"fetch-the-code-step-5"},"Fetch the code (step 5)"),(0,r.kt)("p",null,"This first step of staging, fetching the code, downloads the code from S3 storage.\nThis makes the code available to the following steps."),(0,r.kt)("h2",{id:"unpack-the-sources-step-6"},"Unpack the sources (step 6)"),(0,r.kt)("p",null,"The second step of staging detects the type of the archive and unpacks it.\nSupported formats are: ",(0,r.kt)("strong",{parentName:"p"},"zip"),", ",(0,r.kt)("strong",{parentName:"p"},"tar"),", ",(0,r.kt)("strong",{parentName:"p"},"tgz"),", ",(0,r.kt)("strong",{parentName:"p"},"tbz"),", and ",(0,r.kt)("strong",{parentName:"p"},"txz")),(0,r.kt)("h2",{id:"stage-step-7"},"Stage (step 7)"),(0,r.kt)("p",null,"The third step of staging uses the\n",(0,r.kt)("a",{parentName:"p",href:"https://paketo.io/"},"Paketo buildpacks"),"\nto create a container image for your application.\nThe result of a successful staging process is a new image.\nThis image is pushed to the Registry component of Epinio.\nRead further information in the ",(0,r.kt)("a",{parentName:"p",href:"/next/explanations/advanced#container-registry"},"Epinio Registry")," documentation."),(0,r.kt)("h2",{id:"run-step-8"},"Run (step 8)"),(0,r.kt)("p",null,"Only having a container image isn't enough to run a workload on Kubernetes.\nYou need, as a minimum, a Pod running, with at least one container running that image."),(0,r.kt)("p",null,"The API server provides these requirements\non demand by the client (8a) after it finishes the staging process."),(0,r.kt)("p",null,"The most important resources created (8c) are a\n",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/"},"Deployment"),",\na ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/service/"},"Service")," and an\n",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/ingress/"},"Ingress")," resource."),(0,r.kt)("p",null,"The needed resources are part of a Helm chart which Epinio uses to deploy the application.\nThe application Helm chart source is located here:\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/epinio/helm-charts/tree/main/chart/application"},"Epinio application helm chart"),"."),(0,r.kt)("p",null,"As it's a Helm release, you can list the deployed applications using Helm:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-console"},"helm list -n workspace\n")),(0,r.kt)("p",null,"This assumes application deployment is in the ",(0,r.kt)("inlineCode",{parentName:"p"},"workspace")," namespace."),(0,r.kt)("h2",{id:"pull-image-step-9"},"Pull image (step 9)"),(0,r.kt)("p",null,"The Deployment uses the image pushed as part of the staging step (7).\nNow, the kubelet pulls the image from the registry so the deployment resource can use it (9)."),(0,r.kt)("p",null,"You can read how these resources work in Kubernetes using the provided links but if you have to know one thing is that Ingress is the thing that describes how a request that uses the Application's url is routed to the application container. In Kubernetes, the thing that reads that description and implements the routing is called an Ingress Controller. Such an Ingress Controller is provided by ",(0,r.kt)("a",{parentName:"p",href:"https://doc.traefik.io/traefik/providers/kubernetes-ingress/"},"Traefik"),"."),(0,r.kt)("h2",{id:"ingress-implementation"},"Ingress implementation"),(0,r.kt)("p",null,"Epinio needs an ingress controller to work."),(0,r.kt)("p",null,"Something needs to manage routing your applications URL to the application container.\nThe Kubernetes component that describes and implements this routing is the Ingress Controller. ",(0,r.kt)("a",{parentName:"p",href:"https://doc.traefik.io/traefik/providers/kubernetes-ingress/"},"Traefik")," is an Ingress Controller used by the Epinio project."),(0,r.kt)("p",null,"The ingress controller reads your Ingress Resource Definitions and implements the desired routing to the appropriate Services/Pods."),(0,r.kt)("p",null,"There is further information in the ingress controller section in ",(0,r.kt)("a",{parentName:"p",href:"/next/explanations/advanced#ingress-controller"},'"Advanced Topics"')),(0,r.kt)("p",null,"In Epinio, for every application, you create an Ingress that routes the traffic for the application through a subdomain that looks similar to this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-console"},"myapplication.my_epinio_system_domain.com\n")),(0,r.kt)("p",null,"You can get your application routing with ",(0,r.kt)("inlineCode",{parentName:"p"},"epinio apps list")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"epinio apps show myapplication"),".\nBy specifying one or more ",(0,r.kt)("inlineCode",{parentName:"p"},"--route")," options, either with the ",(0,r.kt)("inlineCode",{parentName:"p"},"epinio push")," command or later with ",(0,r.kt)("inlineCode",{parentName:"p"},"epinio app update"),",\nit's possible to set and use arbitrary custom routes for the application.\nYou need to make sure that these custom domains point to your Ingress controller IP."),(0,r.kt)("h2",{id:"the-process-diagram"},"The process diagram"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"epinio-push-detailed",src:n(15508).Z,title:"Epinio push",width:"2664",height:"1393"})),(0,r.kt)("h2",{id:"credits"},"Credits"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Icons from: ",(0,r.kt)("a",{parentName:"li",href:"https://materialdesignicons.com/"},"https://materialdesignicons.com/")," (Source: ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/Templarian/MaterialDesign"},"https://github.com/Templarian/MaterialDesign"),")")))}d.isMDXComponent=!0},15508:function(e,t,n){t.Z=n.p+"assets/images/epinio-push-detailed-4de43faabdf019287ad2090b9a6baa35.svg"}}]);