"use strict";(self.webpackChunkepinio_docusaurus=self.webpackChunkepinio_docusaurus||[]).push([[2199],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=s(n),h=i,d=u["".concat(p,".").concat(h)]||u[h]||m[h]||o;return n?a.createElement(d,r(r({ref:t},c),{},{components:n})):a.createElement(d,r({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var s=2;s<o;s++)r[s]=n[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},95377:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return p},default:function(){return h},frontMatter:function(){return l},metadata:function(){return s},toc:function(){return m}});var a=n(83117),i=n(80102),o=(n(67294),n(3905)),r=["components"],l={sidebar_label:"Creating Custom Application Helm Charts",sidebar_position:15,title:""},p="Introduction",s={unversionedId:"howtos/create_custom_appcharts",id:"version-1.8.0/howtos/create_custom_appcharts",title:"",description:"Epinio deploys applications on Kubernetes as Helm charts.",source:"@site/versioned_docs/version-1.8.0/howtos/create_custom_appcharts.md",sourceDirName:"howtos",slug:"/howtos/create_custom_appcharts",permalink:"/howtos/create_custom_appcharts",draft:!1,editUrl:"https://github.com/epinio/docs/edit/main/versioned_docs/version-1.8.0/howtos/create_custom_appcharts.md",tags:[],version:"1.8.0",sidebarPosition:15,frontMatter:{sidebar_label:"Creating Custom Application Helm Charts",sidebar_position:15,title:""},sidebar:"docs",previous:{title:"Custom Builders",permalink:"/howtos/custom_builder"},next:{title:"How To Use Custom Application Helm Charts",permalink:"/howtos/using_custom_appcharts"}},c={},m=[{value:"Creating the Helm chart",id:"creating-the-helm-chart",level:2},{value:"Making the helm Chart known to Epinio",id:"making-the-helm-chart-known-to-epinio",level:2},{value:"User-settable configuration values",id:"user-settable-configuration-values",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Going further",id:"going-further",level:2}],u={toc:m};function h(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"Epinio deploys applications on Kubernetes as ",(0,o.kt)("a",{parentName:"p",href:"https://helm.sh/"},"Helm charts"),"."),(0,o.kt)("p",null,"By default, a standard Helm chart is provided when Epinio is installed.\nHowever, operators may wish to create custom charts specific to their environment, and\nregister them in Epinio, so ",(0,o.kt)("a",{parentName:"p",href:"/howtos/using_custom_appcharts"},"their developers can use them"),"."),(0,o.kt)("h1",{id:"setting-up-a-custom-helm-chart"},"Setting up a custom Helm chart"),(0,o.kt)("p",null,"To add a custom Helm chart to the system, there are two mandatory steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create the chart,"),(0,o.kt)("li",{parentName:"ol"},"Make it known to the Epinio installation")),(0,o.kt)("p",null,"The following two sections explain these steps in detail."),(0,o.kt)("p",null,"An advanced feature of custom application charts is the ability to expose user-settable configuration\nvalues to the user. As doing so crosses both chart creation and registration this feature is\ndescribed in a separate section to keep the necessary information together."),(0,o.kt)("h2",{id:"creating-the-helm-chart"},"Creating the Helm chart"),(0,o.kt)("p",null,"Instead of starting from scratch, you can use the standard chart provided by Epinio as a\ntemplate for the modifications."),(0,o.kt)("p",null,"To do so it is possible to download the chart directly from\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/epinio/helm-charts/tree/main/chart/application"},"here")," into a directory ",(0,o.kt)("inlineCode",{parentName:"p"},"D")," of\nyour choice, or, you can clone the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/epinio/helm-charts.git"},"Epinio Helm chart\nrepo"),", again into a directory ",(0,o.kt)("inlineCode",{parentName:"p"},"D")," of your choice."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://github.com/epinio/helm-charts.git\n")),(0,o.kt)("p",null,"Regardless of method, the chart will be located in the sub directory\n",(0,o.kt)("inlineCode",{parentName:"p"},"helm-charts/chart/application"),"."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"The coming steps, especially the commands given, assume that the reader uses the chosen directory\n",(0,o.kt)("inlineCode",{parentName:"p"},"D")," as their working directory.")),(0,o.kt)("p",null,"In this How-To, we will create a variant of the chart by adding an annotation to every\napplication ",(0,o.kt)("inlineCode",{parentName:"p"},"Deployment"),". The annotation will enable the filtering of Epinio applications\nin ",(0,o.kt)("a",{parentName:"p",href:"https://www.fluentd.org/"},"fluentd"),"."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Explanations about setting up and using ",(0,o.kt)("inlineCode",{parentName:"p"},"fluentd")," are out of scope for this How-To.")),(0,o.kt)("p",null,"Open the file ",(0,o.kt)("inlineCode",{parentName:"p"},"helm-charts/chart/application/templates/deployment.yaml")," in your editor of\nchoice.  This file is the template for the application's ",(0,o.kt)("inlineCode",{parentName:"p"},"Deployment")," resource."),(0,o.kt)("p",null,"First, locate the section ",(0,o.kt)("inlineCode",{parentName:"p"},"annotations"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"[...]\n  template:\n    metadata:\n      annotations:\n        app.kubernetes.io/name: {{ .Values.epinio.appName }}\n[...]\n")),(0,o.kt)("p",null,"Add the following annotations:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'fluentd-enable: "true"\nfluentd-application-name: {{ .Values.epinio.appName }}\n')),(0,o.kt)("p",null,"The result should look like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'[...]\n  template:\n    metadata:\n      annotations:\n        fluentd-enable: "true"\n        fluentd-application-name: {{ .Values.epinio.appName }}\n        app.kubernetes.io/name: {{ .Values.epinio.appName }}\n[...]\n')),(0,o.kt)("p",null,"Note how the templating uses the ",(0,o.kt)("inlineCode",{parentName:"p"},".Values.epinio.appName")," field to insert the application\nname into the annotation."),(0,o.kt)("p",null,"The full set of values Epinio sets when deploying an application through the chart is explained in\nthe ",(0,o.kt)("a",{parentName:"p",href:"/references/customization/appcharts#configuration"},"Application Chart Reference"),",\nor locally in the comments at the top of file ",(0,o.kt)("inlineCode",{parentName:"p"},"helm-charts/chart/application/values.yaml"),"."),(0,o.kt)("p",null,"Once you have modified the chart to your needs, use the following command to package the changed\nchart into a tarball:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"helm package helm-charts/chart/application\n")),(0,o.kt)("p",null,"The tarball is placed into the current working directory and the filename should be\n",(0,o.kt)("inlineCode",{parentName:"p"},"application-VERSION.tgz")," where ",(0,o.kt)("inlineCode",{parentName:"p"},"VERSION")," is the chart version."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"We didn't change the chart version. Versioned chart development is out of scope for this How-To.")),(0,o.kt)("h2",{id:"making-the-helm-chart-known-to-epinio"},"Making the helm Chart known to Epinio"),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Once the new chart is created as decribed in the previous section, it is necessary to place the\ngenerated tarball on an accessible web server. Possible options are"),(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},"A server in the public cloud accessible to you"),(0,o.kt)("li",{parentName:"ul"},"The company's host web server, if accessible, and permitted by company policies"),(0,o.kt)("li",{parentName:"ul"},"A personal web server"),(0,o.kt)("li",{parentName:"ul"},"A local web webserver, like an nginx in a docker container"),(0,o.kt)("li",{parentName:"ul"},"etc. ")),(0,o.kt)("p",{parentName:"admonition"},"Given the plethora of possible options, this How-To simply assumes that the tarball is\navailable at the example URL"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre"},"https://mydomain.org/epinio-application-fluentd.tgz\n")),(0,o.kt)("p",{parentName:"admonition"},"and puts the burden on you, the reader, to change this url to match the actually chosen location,\nincluding the name of the tar file.")),(0,o.kt)("p",null,"Copy the following text, change the ",(0,o.kt)("inlineCode",{parentName:"p"},"RELEASE_NAMESPACE")," value to the namespace where\nEpinio was installed into (by default it is ",(0,o.kt)("inlineCode",{parentName:"p"},"epinio"),") and add it to a file of your choice:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"apiVersion: application.epinio.io/v1\nkind: AppChart\nmetadata:\n  namespace: RELEASE_NAMESPACE\n  name: fluentd\nspec:\n  shortDescription: Fluentd filterable standard deployment\n  description: Epinio standard support chart extended for fluentd filtering\n  helmChart: https://mydomain.org/epinio-application-fluentd.tgz\n")),(0,o.kt)("p",null,"This How-To now simply assumes that the chosen file is named:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"fluentd-appchart.yaml\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"This is a Kubernetes custom resource, which will describe the new Helm chart to Epinio.  In this\nexample, it provides the information about the name, the source and descriptions.")),(0,o.kt)("p",null,"The necessary Kubernetes CRD is provided by the Epinio installation."),(0,o.kt)("p",null,"Apply this resource to the Epinio cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kubectl apply -f fluentd-appchart.yaml\n")),(0,o.kt)("p",null,"Verify that the new chart is now registered in Epinio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"epinio app chart list\n")),(0,o.kt)("p",null,"You can also see the details of the chart in Epinio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"epinio app chart show fluentd\n")),(0,o.kt)("h2",{id:"user-settable-configuration-values"},"User-settable configuration values"),(0,o.kt)("p",null,"To expose some user-settable configuration value ",(0,o.kt)("inlineCode",{parentName:"p"},"foo")," the created application chart has to look for\nthis variable in the ",(0,o.kt)("inlineCode",{parentName:"p"},".Values.userConfig")," map, i.e. it has to use the helm variable\n",(0,o.kt)("inlineCode",{parentName:"p"},".Values.userConfig.foo"),"."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The chart is expected to use a sensible default value when this helm variable is not set.")),(0,o.kt)("p",null,"With the application chart exposing ",(0,o.kt)("inlineCode",{parentName:"p"},"foo")," as described above Epinio has to be made aware of the\nconfiguration value by adding a specification to the ",(0,o.kt)("inlineCode",{parentName:"p"},"AppChart")," resource describing it."),(0,o.kt)("p",null,"This is done by adding an entry ",(0,o.kt)("inlineCode",{parentName:"p"},"foo")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.settings")," map of the AppChart resource.  This\nentry is itself a map, with a mandatory ",(0,o.kt)("inlineCode",{parentName:"p"},"type")," field, and type-dependent ",(0,o.kt)("strong",{parentName:"p"},"optional")," restrictions\non the valid values of ",(0,o.kt)("inlineCode",{parentName:"p"},"foo"),"."),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'kind: AppChart\nmetadata:\n  [...]\nspec:\n  [...]\n  settings:\n    foo:\n      type: integer\n      minimum: \'42\'\n    bar:\n      type: number\n      maximum: \'122\'\n    flag:\n       type: bool\n    mode:\n      type: string\n      enum:\n        - "sequential"\n        - "out of order"\n        - "randomized"\n')),(0,o.kt)("p",null,"The valid types and their possible restrictions are:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Type"),(0,o.kt)("th",{parentName:"tr",align:null},"Restriction"),(0,o.kt)("th",{parentName:"tr",align:null},"Semantics"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"integer")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"minimum")),(0,o.kt)("td",{parentName:"tr",align:null},"Minimum valid integer value")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null}),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"maximum")),(0,o.kt)("td",{parentName:"tr",align:null},"Maximum valid integer value")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"number")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"minimum")),(0,o.kt)("td",{parentName:"tr",align:null},"s.a., floating point")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null}),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"maximum")),(0,o.kt)("td",{parentName:"tr",align:null},"s.a., floating point")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"string")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"enum")),(0,o.kt)("td",{parentName:"tr",align:null},"Sequence of valid values")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"bool")),(0,o.kt)("td",{parentName:"tr",align:null},"n/a"),(0,o.kt)("td",{parentName:"tr",align:null})))),(0,o.kt)("p",null,"Restrictions set on a type not supporting them, for example a ",(0,o.kt)("inlineCode",{parentName:"p"},"minimum")," on a ",(0,o.kt)("inlineCode",{parentName:"p"},"string"),"-type\nconfiguration value, are ignored."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The restriction values have to be YAML ",(0,o.kt)("strong",{parentName:"p"},"strings"),", regardless the type of the configuration value.\nNote how in the example above the ",(0,o.kt)("inlineCode",{parentName:"p"},"maximum")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"minimum")," values are quoted to make them strings.")),(0,o.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("p",null,"If the new Helm chart is not correctly registered in Epinio, check that the\n",(0,o.kt)("inlineCode",{parentName:"p"},"RELEASE_NAMESPACE")," was properly set in ",(0,o.kt)("inlineCode",{parentName:"p"},"fluentd-appchart.yaml"),"."),(0,o.kt)("h2",{id:"going-further"},"Going further"),(0,o.kt)("p",null,"The standard app chart, as well as the chart created here use a kubernetes ",(0,o.kt)("inlineCode",{parentName:"p"},"Deployment")," as\nthe main resource describing the active application."),(0,o.kt)("p",null,"Up to Epinio version 1.0, this was the only kind of resource supported."),(0,o.kt)("p",null,"Since Epinio version 1.0+, other kinds of controllers, for example ",(0,o.kt)("inlineCode",{parentName:"p"},"StatefulSet"),", are supported."),(0,o.kt)("p",null,"However, even when changing controllers, it is important to keep the ",(0,o.kt)("inlineCode",{parentName:"p"},"Pod")," annotations and\nlabels the same as for the standard chart. This allows Epinio's server to locate the required resources and\nuse them properly."),(0,o.kt)("p",null,"Here's a couple of examples:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"epinio.io/stage-id")," provides the id of the staging Pod which created the application's image.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"epinio.io/app-container")," provides the name of the application's main ",(0,o.kt)("inlineCode",{parentName:"p"},"Container"),",\nwhich is used by ",(0,o.kt)("inlineCode",{parentName:"p"},"epinio exec"),". This label has to match the actual name of the\ncontainer in the pod spec."))))}h.isMDXComponent=!0}}]);